# PipelineRun with EmptyDir to avoid PVC conflicts
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  namespace: pipelines-as-code
  generateName: ci-pipeline-run-
  annotations:
    pipelinesascode.tekton.dev/on-comment: "/retest"
    pipelinesascode.tekton.dev/on-cel-expression: |
      event == "pull_request" && source_branch.matches("feat/.*") && target_branch == "main"
    pipelinesascode.tekton.dev/cancel-in-progress: "true"
    pipelinesascode.tekton.dev/max-keep-runs: "5"
    pipelinesascode.tekton.dev/task-timeout: "10m"
    pipelinesascode.tekton.dev/pipeline-timeout: "15m"
spec:
  pipelineRef:
    name: ci-pipeline

  params:
    - name: git-url
      value: "https://github.com/xinxin20020807/wudi"
    - name: git-revision
      value: "main"
    - name: image-url
      value: "uhub.service.ucloud.cn/base-images/wudi-app"
    - name: image-tag
      value: "$(context.pipelineRun.name)-$(context.pipelineRun.uid[0:8])"

  # Use EmptyDir to avoid PVC conflicts
  workspaces:
    - name: shared-data
      emptyDir: {}

  # Simplified timeout settings
  timeouts:
    pipeline: "30m"
    tasks: "15m"

  # Simplified pod template
  podTemplate:
    securityContext:
      runAsNonRoot: false
      runAsUser: 0
    # Add resource limits to prevent resource exhaustion
    resources:
      requests:
        memory: "1Gi"
        cpu: "500m"
      limits:
        memory: "4Gi"
        cpu: "2000m"